{% extends "base.html" %}

{% block title %}Registro{% endblock %}

{% block content %}
<div class="register-container">
    <h2>Registro de usuario</h2>

    {% if error %}
        <p class="error">{{ error }}</p>
    {% endif %}

 <form id="registerForm">
    <div class="form-group">
        <label for="email">Correo:</label>
        <input type="email" id="email" name="email" required />
    </div>

    <div class="form-group" id="nombreCompletoGroup">
        <label for="nombre_completo">Nombre completo:</label>
        <input type="text" id="nombre_completo" name="nombre_completo" />
    </div>

    <div class="form-group">
        <label for="rol">Rol:</label>
        <select id="rol" name="rol" required>
            <option value="">-- Selecciona un rol --</option>
            <option value="paciente">Paciente</option>
            <option value="medico">Médico</option>
            <option value="admisionista">Admisionista</option>
            <option value="secretaria">Secretaria</option>
        </select>
    </div>

    <!-- CAMPOS ADICIONALES SOLO PARA PACIENTE -->
<div id="camposPaciente" style="display:none; margin-top:20px;">

    <h3>Datos del paciente</h3>

    <div class="form-group">
        <label for="tipo_documento">Tipo de documento:</label>
        <select id="tipo_documento" name="tipo_documento">
            <option value="">-- Selecciona un tipo --</option>
            <option value="CC">Cédula de Ciudadanía (CC)</option>
            <option value="TI">Tarjeta de Identidad (TI)</option>
            <option value="CE">Cédula de Extranjería (CE)</option>
            <option value="PA">Pasaporte (PA)</option>
            <option value="PE">Permiso de Extranjería (PE)</option>
            <option value="NIT">NIT</option>
        </select>
    </div>

    <div class="form-group">
        <label for="numero_documento">Número de documento:</label>
        <input type="text" id="numero_documento" name="numero_documento" />
    </div>

    <div class="form-group">
        <label for="primer_apellido">Primer apellido:</label>
        <input type="text" id="primer_apellido" name="primer_apellido" />
    </div>

    <div class="form-group">
        <label for="segundo_apellido">Segundo apellido:</label>
        <input type="text" id="segundo_apellido" name="segundo_apellido" />
    </div>

    <div class="form-group">
        <label for="primer_nombre">Primer nombre:</label>
        <input type="text" id="primer_nombre" name="primer_nombre" />
    </div>

    <div class="form-group">
        <label for="segundo_nombre">Segundo nombre:</label>
        <input type="text" id="segundo_nombre" name="segundo_nombre" />
    </div>

    <div class="form-group">
        <label for="fecha_nacimiento">Fecha de nacimiento:</label>
        <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" />
    </div>

    <div class="form-group">
        <label for="sexo">Sexo:</label>
        <select id="sexo" name="sexo">
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
            <option value="O">Otro</option>
        </select>
    </div>

    <div class="form-group">
        <label for="direccion_residencia">Dirección:</label>
        <input type="text" id="direccion_residencia" name="direccion_residencia" />
    </div>

    <div class="form-group">
        <label for="municipio_ciudad">Municipio/Ciudad:</label>
        <input type="text" id="municipio_ciudad" name="municipio_ciudad" />
    </div>

    <div class="form-group">
        <label for="departamento">Departamento:</label>
        <input type="text" id="departamento" name="departamento" />
    </div>

    <div class="form-group">
        <label for="telefono">Teléfono:</label>
        <input type="text" id="telefono" name="telefono" />
    </div>

    <div class="form-group">
        <label for="celular">Celular:</label>
        <input type="text" id="celular" name="celular" />
    </div>

    <div class="form-group">
        <label for="ocupacion">Ocupación:</label>
        <input type="text" id="ocupacion" name="ocupacion" />
    </div>

    <div class="form-group">
        <label for="entidad_pertenece">EPS / Entidad:</label>
        <input type="text" id="entidad_pertenece" name="entidad_pertenece" />
    </div>

    <div class="form-group">
        <label for="regimen_afiliacion">Régimen:</label>
        <select id="regimen_afiliacion" name="regimen_afiliacion">
            <option value="contributivo">Contributivo</option>
            <option value="subsidiado">Subsidiado</option>
            <option value="especial">Especial</option>
        </select>
    </div>

    <!-- El campo tipo_usuario se hereda del rol seleccionado; no mostrarlo en el formulario -->

</div>

    <!-- CAMPOS ADICIONALES SOLO PARA MEDICO -->
<div id="camposMedico" style="display:none; margin-top:20px;">

    <h3>Datos del profesional</h3>

    <div class="form-group">
        <label for="tipo_profesional">Especialidad:</label>
        <input type="text" id="tipo_profesional" name="tipo_profesional" placeholder="ej: Cardiólogo, Pediatra" />
    </div>

    <div class="form-group">
        <label for="registro_medico">Registro/Cédula profesional:</label>
        <input type="text" id="registro_medico" name="registro_medico" placeholder="ej: RM-123456" />
    </div>

    <div class="form-group">
        <label for="cargo_servicio">Cargo / Servicio:</label>
        <input type="text" id="cargo_servicio" name="cargo_servicio" placeholder="ej: Jefe de Cardiología" />
    </div>

    <div class="form-group">
        <label for="firma_profesional">Firma (identificador único):</label>
        <input type="text" id="firma_profesional" name="firma_profesional" placeholder="ej: JCP-2025" />
    </div>

</div>

    <div class="form-group">
        <label for="password">Contraseña:</label>
        <input type="password" id="password" name="password" required />
    </div>

    <button type="submit">Registrarse</button>
</form>

<script>
function generarUsername(nombreCompleto) {
    const slug = nombreCompleto
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "");

    const random = Math.random().toString(36).substring(2, 6);
    return `${slug}-${random}`;
}

// --- CORRECTO: Listener para mostrar camposPaciente ---
document.getElementById("rol").addEventListener("change", function() {
    const rol = this.value;
    const campos = document.getElementById("camposPaciente");
    campos.style.display = rol === "paciente" ? "block" : "none";
});
function handleRoleChange() {
    const rol = document.getElementById("rol").value;
    const campos = document.getElementById("camposPaciente");
    const camposMed = document.getElementById("camposMedico");
    const nombreGroup = document.getElementById("nombreCompletoGroup");
    // Si es paciente, ocultar el campo de Nombre completo y mostrar los campos de paciente
    if (rol === "paciente") {
        campos.style.display = "block";
        camposMed.style.display = "none";
        if (nombreGroup) nombreGroup.style.display = "none";
    } else if (rol === "medico") {
        campos.style.display = "none";
        camposMed.style.display = "block";
        if (nombreGroup) nombreGroup.style.display = "block";
    } else if (rol === "") {
        // rol no seleccionado: ocultar campos de paciente y mostrar nombre completo
        campos.style.display = "none";
        camposMed.style.display = "none";
        if (nombreGroup) nombreGroup.style.display = "block";
    } else {
        campos.style.display = "none";
        camposMed.style.display = "none";
        if (nombreGroup) nombreGroup.style.display = "block";
    }
}

document.getElementById("rol").addEventListener("change", handleRoleChange);

// Ejecutar al cargar la página para aplicar el estado inicial según la opción seleccionada
document.addEventListener("DOMContentLoaded", function() {
    handleRoleChange();
});

// --- SUBMIT ---
document.getElementById("registerForm").addEventListener("submit", async function(event) {
    event.preventDefault();

    // Determinar nombre completo: si está vacío y es paciente, construirlo desde los campos individuales
    let nombre = (document.getElementById("nombre_completo").value || "").trim();
    const rolSeleccionado = document.getElementById("rol").value;
    if (!nombre && rolSeleccionado === "paciente") {
        const pn = (document.getElementById("primer_nombre").value || "").trim();
        const sn = (document.getElementById("segundo_nombre").value || "").trim();
        const pa = (document.getElementById("primer_apellido").value || "").trim();
        const sa = (document.getElementById("segundo_apellido").value || "").trim();
        nombre = [pn, sn, pa, sa].filter(Boolean).join(' ').trim();
    }
    if (!nombre) {
        // fallback al email si aún vacío
        nombre = document.getElementById("email").value || "usuario";
    }

    const usernameGenerado = generarUsername(nombre);

    const formData = new URLSearchParams();
    formData.append("username", usernameGenerado);
    formData.append("email", document.getElementById("email").value);
    formData.append("nombre_completo", nombre);
    formData.append("rol", rolSeleccionado);
    formData.append("password", document.getElementById("password").value);

    // Campos de paciente
    if (rolSeleccionado === "paciente") {
        formData.append("tipo_documento", document.getElementById("tipo_documento").value);
        formData.append("numero_documento", document.getElementById("numero_documento").value);
        formData.append("primer_apellido", document.getElementById("primer_apellido").value);
        formData.append("segundo_apellido", document.getElementById("segundo_apellido").value);
        formData.append("primer_nombre", document.getElementById("primer_nombre").value);
        formData.append("segundo_nombre", document.getElementById("segundo_nombre").value);
        formData.append("fecha_nacimiento", document.getElementById("fecha_nacimiento").value);
        formData.append("sexo", document.getElementById("sexo").value);
        formData.append("direccion_residencia", document.getElementById("direccion_residencia").value);
        formData.append("municipio_ciudad", document.getElementById("municipio_ciudad").value);
        formData.append("departamento", document.getElementById("departamento").value);
        formData.append("telefono", document.getElementById("telefono").value);
        formData.append("celular", document.getElementById("celular").value);
        formData.append("ocupacion", document.getElementById("ocupacion").value);
        formData.append("entidad_pertenece", document.getElementById("entidad_pertenece").value);
        formData.append("regimen_afiliacion", document.getElementById("regimen_afiliacion").value);

        // correo_electronico aquí es el correo principal
        formData.append("correo_electronico", document.getElementById("email").value);
    }

    // Campos de médico
    if (rolSeleccionado === "medico") {
        formData.append("tipo_profesional", document.getElementById("tipo_profesional").value);
        formData.append("registro_medico", document.getElementById("registro_medico").value);
        formData.append("cargo_servicio", document.getElementById("cargo_servicio").value);
        formData.append("firma_profesional", document.getElementById("firma_profesional").value);
    }

    // Enviar tipo_usuario heredado del rol seleccionado (evita redundancia)
    formData.append("tipo_usuario", rolSeleccionado);

    try {
        const backendHost = "http://localhost:8001";

        const response = await fetch(`${backendHost}/auth/register`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData
        });

        const result = await response.json().catch(() => ({}));

        if (!response.ok) {
            alert(result.detail || "Error en el registro");
            return;
        }

        alert(`Registro exitoso.\nUsuario generado: ${usernameGenerado}`);
        window.location.href = "/";
    } catch (err) {
        alert("Error al conectar con el servidor");
    }
});
</script>

{% endblock %}
